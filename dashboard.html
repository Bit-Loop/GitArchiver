<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Archive Scraper - Enhanced Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        .tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }
        .tab.active {
            background: rgba(255,255,255,0.2);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.18);
        }
        .card h3 {
            margin-bottom: 15px;
            color: #5a67d8;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }
        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-good { background-color: #48bb78; }
        .status-warning { background-color: #ed8936; }
        .status-danger { background-color: #f56565; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            transition: width 0.5s ease;
        }
        .progress-warning { background: linear-gradient(90deg, #ed8936, #dd6b20); }
        .progress-danger { background: linear-gradient(90deg, #f56565, #e53e3e); }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-danger { background: linear-gradient(45deg, #f56565, #e53e3e); }
        .btn-success { background: linear-gradient(45deg, #48bb78, #38a169); }
        .btn-warning { background: linear-gradient(45deg, #ed8936, #dd6b20); }
        .rate-limit-monitor {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .rate-limit-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .rate-metric {
            text-align: center;
            padding: 15px;
            background: rgba(106, 90, 205, 0.1);
            border-radius: 10px;
        }
        .rate-metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #5a67d8;
        }
        .rate-metric-label {
            color: #666;
            margin-top: 5px;
        }
        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .control-group {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log-viewer {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        .data-table th {
            background: #5a67d8;
            color: white;
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid;
        }
        .alert-info { background: #e6fffa; border-color: #38b2ac; color: #234e52; }
        .alert-warning { background: #fffaf0; border-color: #ed8936; color: #744210; }
        .alert-success { background: #f0fff4; border-color: #48bb78; color: #276749; }
        .alert-danger { background: #fed7d7; border-color: #f56565; color: #742a2a; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-content h3 {
            color: #5a67d8;
            margin-bottom: 20px;
            text-align: center;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
        .close:hover { color: #333; }
        .wordlist-section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .wordlist-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ GitHub Archive Scraper</h1>
            <p>Professional Edition - Real-time GitHub Event Processing</p>
            
            <!-- Authentication Status -->
            <div id="authSection" style="margin-top: 20px; text-align: right;">
                <div id="authStatus" style="display: inline-block; margin-right: 15px; color: white; font-weight: bold;">
                    <span id="authIndicator">üîê Checking authentication...</span>
                </div>
                <button id="authButton" class="btn btn-success" onclick="toggleAuth()" style="padding: 8px 16px; font-weight: bold;">
                    üîê Login
                </button>
            </div>
        </div>

        <!-- Rate Limit Monitor -->
        <div class="rate-limit-monitor">
            <h3>üö¶ Rate Limit Monitor</h3>
            <div class="rate-limit-status" id="rateLimitStatus">
                <div class="rate-metric">
                    <div class="rate-metric-value" id="remainingRequests">-</div>
                    <div class="rate-metric-label">Remaining</div>
                </div>
                <div class="rate-metric">
                    <div class="rate-metric-value" id="resetTime">-</div>
                    <div class="rate-metric-label">Reset Time</div>
                </div>
                <div class="rate-metric">
                    <div class="rate-metric-value" id="requestsMade">-</div>
                    <div class="rate-metric-label">Used</div>
                </div>
                <div class="rate-metric">
                    <div class="rate-metric-value" id="rateLimitType">-</div>
                    <div class="rate-metric-label">API Type</div>
                </div>
            </div>
            <div id="rateLimitAlert" class="alert" style="display: none;"></div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('scraper')">‚öôÔ∏è Scraper Control</button>
            <button class="tab" onclick="showTab('database')">üóÑÔ∏è Database</button>
            <button class="tab" onclick="showTab('wordlists')">üîç Bug Bounty Tools</button>
            <button class="tab" onclick="showTab('import')">üì• Data Import</button>
            <button class="tab" onclick="showTab('logs')">üìú Logs</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="status-grid">
                <div class="card">
                    <h3>üñ•Ô∏è System Status</h3>
                    <div id="systemStatus">
                        <div class="metric">
                            <span>API Status</span>
                            <span class="metric-value" id="apiStatus">
                                <span class="status-indicator status-good"></span>Running
                            </span>
                        </div>
                        <div class="metric">
                            <span>Database</span>
                            <span class="metric-value" id="dbStatus">
                                <span class="status-indicator status-good"></span>Connected
                            </span>
                        </div>
                        <div class="metric">
                            <span>Scraper</span>
                            <span class="metric-value" id="scraperStatus">
                                <span class="status-indicator status-warning"></span>Checking...
                            </span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üíæ Resource Usage</h3>
                    <div id="resourceUsage">
                        <div class="metric">
                            <span>Memory Usage</span>
                            <span class="metric-value" id="memoryUsage">Loading...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="memoryProgress" style="width: 0%"></div>
                        </div>
                        
                        <div class="metric">
                            <span>Disk Usage</span>
                            <span class="metric-value" id="diskUsage">Loading...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="diskProgress" style="width: 0%"></div>
                        </div>
                        
                        <div class="metric">
                            <span>CPU Usage</span>
                            <span class="metric-value" id="cpuUsage">Loading...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="cpuProgress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>üìä Database Statistics</h3>
                    <div id="dbStats">
                        <div class="metric">
                            <span>Total Events</span>
                            <span class="metric-value" id="totalEvents">Loading...</span>
                        </div>
                        <div class="metric">
                            <span>Repositories</span>
                            <span class="metric-value" id="totalRepos">Loading...</span>
                        </div>
                        <div class="metric">
                            <span>Processed Files</span>
                            <span class="metric-value" id="processedFiles">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scraper Control Tab -->
        <div id="scraper" class="tab-content">
            <div class="controls-section">
                <div class="control-group">
                    <h3>üéõÔ∏è Scraper Controls</h3>
                    <button class="btn btn-success" onclick="startScraper()">‚ñ∂Ô∏è Start Scraper</button>
                    <button class="btn btn-warning" onclick="pauseScraper()">‚è∏Ô∏è Pause</button>
                    <button class="btn btn-success" onclick="resumeScraper()">‚ñ∂Ô∏è Resume</button>
                    <button class="btn btn-danger" onclick="stopScraper()">‚èπÔ∏è Stop</button>
                    <button class="btn" onclick="restartScraper()">üîÑ Restart</button>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>
                            <input type="checkbox" id="autoResumeEnabled" checked> Auto-Resume on Rate Limit Recovery
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üì• Archive Download</h3>
                    <div class="form-group">
                        <label>Date Range:</label>
                        <input type="date" id="dateFrom" />
                        <input type="date" id="dateTo" />
                    </div>
                    <button class="btn" onclick="searchArchives()">üîç Search Available Archives</button>
                    <button class="btn" onclick="downloadSelected()">‚¨áÔ∏è Download Selected</button>
                </div>

                <div class="control-group">
                    <h3>üéØ Keyword-Based Download</h3>
                    <div class="form-group">
                        <label>Keywords (comma-separated):</label>
                        <textarea id="keywords" placeholder="security, vulnerability, exploit"></textarea>
                    </div>
                    <button class="btn" onclick="downloadByKeywords()">üöÄ Start Systematic Download</button>
                </div>
            </div>

            <div class="card" id="scraperStatusCard">
                <h3>üìä Scraper Performance</h3>
                <div id="scraperPerformance">Loading...</div>
            </div>
        </div>

        <!-- Database Tab -->
        <div id="database" class="tab-content">
            <div class="controls-section">
                <div class="control-group">
                    <h3>üîç Repository Search</h3>
                    <div class="form-group">
                        <input type="text" id="repoSearch" placeholder="Search repositories...">
                        <button class="btn" onclick="searchRepositories()">Search</button>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üóëÔ∏è Data Management</h3>
                    <button class="btn btn-warning" onclick="pruneData()">üßπ Prune Old Data</button>
                    <button class="btn btn-danger" onclick="removeSelected()">üóëÔ∏è Remove Selected</button>
                </div>

                <div class="control-group">
                    <h3>üíΩ Disk Usage</h3>
                    <button class="btn" onclick="getDiskUsage()">üìä Analyze Disk Usage</button>
                    <div id="diskUsageDetails"></div>
                </div>
            </div>

            <div class="card">
                <h3>üìã Repository List</h3>
                <div id="repositoryList">
                    <p>Click search to load repositories...</p>
                </div>
            </div>
        </div>

        <!-- Bug Bounty Tools Tab -->
        <div id="wordlists" class="tab-content">
            <div class="wordlist-section">
                <h3>üéØ Intelligent Wordlist Generator</h3>
                
                <div class="wordlist-form">
                    <div class="form-group">
                        <label>Target Domains:</label>
                        <textarea id="targetDomains" placeholder="example.com, target.org"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Technologies:</label>
                        <select id="technologies" multiple>
                            <option value="javascript">JavaScript</option>
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="php">PHP</option>
                            <option value="go">Go</option>
                            <option value="rust">Rust</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Days Back:</label>
                        <input type="number" id="daysBack" value="30" min="1" max="365">
                    </div>
                    
                    <div class="form-group">
                        <label>Max Words:</label>
                        <input type="number" id="maxWords" value="10000" min="100" max="50000">
                    </div>
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-success" onclick="generateComprehensiveWordlists()">üöÄ Generate Comprehensive Wordlists</button>
                    <button class="btn" onclick="generateTargetedWordlist()">üéØ Generate Targeted Wordlist</button>
                </div>
            </div>

            <div class="wordlist-section">
                <h3>üìä Generated Wordlists</h3>
                <div id="wordlistResults">
                    <p>No wordlists generated yet. Use the tools above to create wordlists for bug bounty hunting.</p>
                </div>
            </div>
        </div>

        <!-- Data Import Tab -->
        <div id="import" class="tab-content">
            <div class="controls-section">
                <div class="control-group">
                    <h3>üìÅ JSON File Import</h3>
                    <div class="form-group">
                        <label>File Path:</label>
                        <input type="text" id="jsonFilePath" placeholder="/path/to/events.json.gz">
                    </div>
                    <button class="btn" onclick="importJsonData()">üì• Import JSON</button>
                </div>

                <div class="control-group">
                    <h3>‚òÅÔ∏è BigQuery Import</h3>
                    <div class="form-group">
                        <label>Project ID:</label>
                        <input type="text" id="projectId" placeholder="your-project-id">
                    </div>
                    <div class="form-group">
                        <label>Dataset ID:</label>
                        <input type="text" id="datasetId" placeholder="github_archive">
                    </div>
                    <div class="form-group">
                        <label>Table ID:</label>
                        <input type="text" id="tableId" placeholder="events_*">
                    </div>
                    <button class="btn" onclick="importBigQueryData()">‚òÅÔ∏è Import from BigQuery</button>
                </div>
            </div>

            <div class="card">
                <h3>üìä Import Status</h3>
                <div id="importStatus">
                    <p>No active imports</p>
                </div>
            </div>
        </div>

        <!-- Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="card">
                <h3>üìú System Logs</h3>
                <button class="btn" onclick="refreshLogs()">üîÑ Refresh</button>
                <button class="btn" onclick="clearLogs()">üóëÔ∏è Clear Display</button>
                <div class="log-viewer" id="logViewer">
                    Loading logs...
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAuthModal()">&times;</span>
            <h3>üîê Admin Login</h3>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                Enter the admin password to access protected features
            </p>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="authPassword" placeholder="Enter admin password" 
                       onkeypress="if(event.key==='Enter') authenticate()" 
                       style="margin-bottom: 15px;">
            </div>
            <div style="text-align: center;">
                <button class="btn btn-success" onclick="authenticate()">üîì Login</button>
                <button class="btn" onclick="closeAuthModal()" style="margin-left: 10px;">Cancel</button>
            </div>
            <div id="loginError" style="color: red; margin-top: 15px; text-align: center; display: none;"></div>
        </div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let updateInterval;

        // Tab management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'block';
            setTimeout(() => {
                document.getElementById('authPassword').focus();
            }, 100);
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('authPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // Authentication status and toggle
        function checkAuthStatus() {
            fetch('/api/auth/status', {
                headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
            })
            .then(response => response.json())
            .then(data => {
                const authIndicator = document.getElementById('authIndicator');
                const authButton = document.getElementById('authButton');
                
                if (data.authenticated) {
                    authIndicator.textContent = `üîì Logged in as ${data.user}`;
                    authButton.textContent = 'üîí Logout';
                    authButton.className = 'btn btn-warning';
                    authButton.style.display = 'inline-block';
                } else {
                    authIndicator.textContent = 'üîê Not authenticated';
                    authButton.textContent = 'üîê Login';
                    authButton.className = 'btn btn-success';
                    authButton.style.display = 'inline-block';
                }
            })
            .catch(error => {
                console.error('Auth check error:', error);
                document.getElementById('authIndicator').textContent = 'üîê Authentication unavailable';
                const authButton = document.getElementById('authButton');
                authButton.textContent = 'üîê Login';
                authButton.className = 'btn btn-success';
                authButton.style.display = 'inline-block';
            });
        }

        function toggleAuth() {
            const authButton = document.getElementById('authButton');
            if (authButton.textContent === 'üîê Login') {
                showAuthModal();
            } else {
                logout();
            }
        }

        function logout() {
            fetch('/api/logout', {
                method: 'POST',
                headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
            })
            .then(response => response.json())
            .then(data => {
                authToken = null;
                localStorage.removeItem('authToken');
                showAlert('Logged out successfully', 'success');
                checkAuthStatus();
                if (updateInterval) {
                    clearInterval(updateInterval);
                    updateInterval = null;
                }
            })
            .catch(error => {
                showAlert('Logout error: ' + error.message, 'danger');
            });
        }

        // Authentication
        function authenticate() {
            const password = document.getElementById('authPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!password) {
                errorDiv.textContent = 'Please enter a password';
                errorDiv.style.display = 'block';
                return;
            }
            
            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    password: password 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    closeAuthModal(); // Close the modal
                    showAlert('Authentication successful!', 'success');
                    checkAuthStatus(); // Update auth status display
                    startPeriodicUpdates();
                    errorDiv.style.display = 'none';
                } else {
                    errorDiv.textContent = 'Invalid password. Please try again.';
                    errorDiv.style.display = 'block';
                    document.getElementById('authPassword').value = '';
                    document.getElementById('authPassword').focus();
                }
            })
            .catch(error => {
                errorDiv.textContent = 'Authentication error: ' + error.message;
                errorDiv.style.display = 'block';
            });
        }

        function requireAuth() {
            if (!authToken) {
                showAlert('Please login to access this feature', 'warning');
                return false;
            }
            return true;
        }

        // API helpers
        function apiCall(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            return fetch(endpoint, {
                ...options,
                headers: headers
            });
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.body.insertBefore(alertDiv, document.body.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Rate limit monitoring
        function updateRateLimitStatus() {
            fetch('/api/rate-limit/status')
                .then(response => response.json())
                .then(data => {
                    const status = data.rate_limit_status;
                    
                    document.getElementById('remainingRequests').textContent = status.remaining || '-';
                    document.getElementById('requestsMade').textContent = status.used || '-';
                    document.getElementById('rateLimitType').textContent = data.is_authenticated ? 'Authenticated' : 'Public';
                    
                    if (status.reset_time) {
                        const resetTime = new Date(status.reset_time);
                        document.getElementById('resetTime').textContent = resetTime.toLocaleTimeString();
                    }
                    
                    // Show alert if rate limited
                    const alertDiv = document.getElementById('rateLimitAlert');
                    if (status.remaining < 100) {
                        alertDiv.style.display = 'block';
                        alertDiv.className = 'alert alert-warning';
                        alertDiv.textContent = `Rate limit warning: Only ${status.remaining} requests remaining!`;
                    } else if (status.remaining < 10) {
                        alertDiv.className = 'alert alert-danger';
                        alertDiv.textContent = 'Rate limit critical! API requests will be paused.';
                    } else {
                        alertDiv.style.display = 'none';
                    }
                })
                .catch(error => console.error('Rate limit status error:', error));
        }

        // System status updates
        function updateSystemStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update basic status
                    document.getElementById('apiStatus').innerHTML = 
                        '<span class="status-indicator status-good"></span>Running';
                    
                    document.getElementById('dbStatus').innerHTML = data.database_connected ? 
                        '<span class="status-indicator status-good"></span>Connected' :
                        '<span class="status-indicator status-danger"></span>Disconnected';
                    
                    document.getElementById('scraperStatus').innerHTML = data.scraper_running ?
                        '<span class="status-indicator status-good"></span>Running' :
                        '<span class="status-indicator status-warning"></span>Stopped';
                    
                    // Update resource usage
                    const resources = data.resource_status;
                    updateResourceDisplay(resources);
                })
                .catch(error => console.error('Status update error:', error));
        }

        function updateResourceDisplay(resources) {
            // Memory
            document.getElementById('memoryUsage').textContent = 
                `${resources.process_memory_mb}MB / ${resources.process_memory_limit_mb}MB`;
            const memoryPercent = resources.process_memory_usage_percent;
            document.getElementById('memoryProgress').style.width = `${memoryPercent}%`;
            document.getElementById('memoryProgress').className = 
                `progress-fill ${memoryPercent > 80 ? 'progress-danger' : memoryPercent > 60 ? 'progress-warning' : ''}`;

            // Disk
            document.getElementById('diskUsage').textContent = 
                `${resources.disk_used_gb}GB / ${resources.disk_total_gb}GB`;
            const diskPercent = resources.disk_usage_percent;
            document.getElementById('diskProgress').style.width = `${diskPercent}%`;
            document.getElementById('diskProgress').className = 
                `progress-fill ${diskPercent > 80 ? 'progress-danger' : diskPercent > 60 ? 'progress-warning' : ''}`;

            // CPU
            document.getElementById('cpuUsage').textContent = `${resources.cpu_percent}%`;
            const cpuPercent = resources.cpu_percent;
            document.getElementById('cpuProgress').style.width = `${cpuPercent}%`;
            document.getElementById('cpuProgress').className = 
                `progress-fill ${cpuPercent > 80 ? 'progress-danger' : cpuPercent > 60 ? 'progress-warning' : ''}`;
        }

        function updateDatabaseStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalEvents').textContent = data.total_events.toLocaleString();
                    document.getElementById('totalRepos').textContent = data.total_repositories.toLocaleString();
                    document.getElementById('processedFiles').textContent = data.processed_files.toLocaleString();
                })
                .catch(error => console.error('Stats update error:', error));
        }

        // Scraper controls
        function startScraper() {
            if (!requireAuth()) return;
            
            apiCall('/api/start-scraper', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        showAlert(data.message, 'success');
                    } else {
                        showAlert(data.error, 'danger');
                    }
                    updateSystemStatus();
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function stopScraper() {
            if (!requireAuth()) return;
            
            apiCall('/api/stop-scraper', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message || data.error, data.message ? 'success' : 'danger');
                    updateSystemStatus();
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function pauseScraper() {
            if (!requireAuth()) return;
            
            apiCall('/api/pause-scraper', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message || data.error, data.message ? 'warning' : 'danger');
                    updateScraperStatus();
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function resumeScraper() {
            if (!requireAuth()) return;
            
            apiCall('/api/resume-scraper', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message || data.error, data.message ? 'success' : 'danger');
                    updateScraperStatus();
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function restartScraper() {
            if (!requireAuth()) return;
            
            apiCall('/api/restart-scraper', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.message || data.error, data.message ? 'success' : 'danger');
                    updateSystemStatus();
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function updateScraperStatus() {
            fetch('/api/scraper-status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('scraperPerformance');
                    if (data.running) {
                        const info = data.process_info;
                        statusDiv.innerHTML = `
                            <div class="metric">
                                <span>PID:</span>
                                <span class="metric-value">${info.pid}</span>
                            </div>
                            <div class="metric">
                                <span>Status:</span>
                                <span class="metric-value">${info.status}</span>
                            </div>
                            <div class="metric">
                                <span>CPU:</span>
                                <span class="metric-value">${info.cpu_percent.toFixed(1)}%</span>
                            </div>
                            <div class="metric">
                                <span>Memory:</span>
                                <span class="metric-value">${info.memory_mb.toFixed(1)}MB</span>
                            </div>
                            <div class="metric">
                                <span>Threads:</span>
                                <span class="metric-value">${info.num_threads}</span>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `<p>Scraper not running</p>`;
                    }
                })
                .catch(error => console.error('Scraper status error:', error));
        }

        // Wordlist generation
        function generateComprehensiveWordlists() {
            if (!requireAuth()) return;
            
            const targetDomains = document.getElementById('targetDomains').value
                .split(',').map(d => d.trim()).filter(d => d);
            const technologies = Array.from(document.getElementById('technologies').selectedOptions)
                .map(opt => opt.value);
            const daysBack = parseInt(document.getElementById('daysBack').value);
            const maxWords = parseInt(document.getElementById('maxWords').value);
            
            apiCall('/api/wordlists/generate', {
                method: 'POST',
                body: JSON.stringify({
                    target_domains: targetDomains,
                    technologies: technologies,
                    days_back: daysBack,
                    max_words: maxWords
                })
            })
            .then(response => response.json())
            .then(data => {
                showAlert(data.message || data.error, data.success ? 'success' : 'danger');
                if (data.success) {
                    document.getElementById('wordlistResults').innerHTML = 
                        `<p>Wordlist generation started (Task ID: ${data.task_id}). Check back in a few minutes.</p>`;
                }
            })
            .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function generateTargetedWordlist() {
            if (!requireAuth()) return;
            
            const targetDomains = document.getElementById('targetDomains').value
                .split(',').map(d => d.trim()).filter(d => d);
            
            if (targetDomains.length === 0) {
                showAlert('Please enter at least one target domain', 'warning');
                return;
            }
            
            const maxWords = parseInt(document.getElementById('maxWords').value);
            
            apiCall('/api/wordlists/targeted', {
                method: 'POST',
                body: JSON.stringify({
                    target_domain: targetDomains[0],
                    max_words: maxWords
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(`Generated ${data.word_count} words for ${data.target_domain}`, 'success');
                    document.getElementById('wordlistResults').innerHTML = `
                        <h4>Targeted Wordlist for ${data.target_domain}</h4>
                        <p>Generated ${data.word_count} words</p>
                        <p>Preview (first 100): ${data.words.join(', ')}</p>
                        <a href="${data.download_url}" class="btn">Download Full List</a>
                    `;
                } else {
                    showAlert(data.error, 'danger');
                }
            })
            .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        // Data import
        function importJsonData() {
            if (!requireAuth()) return;
            
            const filePath = document.getElementById('jsonFilePath').value;
            if (!filePath) {
                showAlert('Please enter a file path', 'warning');
                return;
            }
            
            apiCall('/api/import/json', {
                method: 'POST',
                body: JSON.stringify({ file_path: filePath })
            })
            .then(response => response.json())
            .then(data => {
                showAlert(data.message || data.error, data.success ? 'success' : 'danger');
                if (data.success) {
                    document.getElementById('importStatus').innerHTML = 
                        `<p>JSON import started (Task ID: ${data.task_id})</p>`;
                }
            })
            .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function importBigQueryData() {
            if (!requireAuth()) return;
            
            const projectId = document.getElementById('projectId').value;
            const datasetId = document.getElementById('datasetId').value;
            const tableId = document.getElementById('tableId').value;
            
            if (!projectId || !datasetId || !tableId) {
                showAlert('Please fill in all BigQuery fields', 'warning');
                return;
            }
            
            apiCall('/api/import/bigquery', {
                method: 'POST',
                body: JSON.stringify({
                    project_id: projectId,
                    dataset_id: datasetId,
                    table_id: tableId
                })
            })
            .then(response => response.json())
            .then(data => {
                showAlert(data.message || data.error, data.success ? 'success' : 'danger');
                if (data.success) {
                    document.getElementById('importStatus').innerHTML = 
                        `<p>BigQuery import started (Task ID: ${data.task_id})</p>`;
                }
            })
            .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        // Repository search
        function searchRepositories() {
            const query = document.getElementById('repoSearch').value;
            if (!query) {
                showAlert('Please enter a search query', 'warning');
                return;
            }
            
            fetch(`/api/search-repositories?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.repositories) {
                        displayRepositories(data.repositories);
                    } else {
                        showAlert(data.error, 'danger');
                    }
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function displayRepositories(repositories) {
            const listDiv = document.getElementById('repositoryList');
            if (repositories.length === 0) {
                listDiv.innerHTML = '<p>No repositories found</p>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr>';
            html += '<th><input type="checkbox" id="selectAll" onchange="toggleAllRepos(this)"></th>';
            html += '<th>Name</th><th>Owner</th><th>Stars</th><th>Language</th><th>Events</th>';
            html += '</tr></thead><tbody>';
            
            repositories.forEach(repo => {
                html += `<tr>
                    <td><input type="checkbox" class="repo-checkbox" value="${repo.id}"></td>
                    <td><strong>${repo.name}</strong><br><small>${repo.description || 'No description'}</small></td>
                    <td>${repo.owner || 'Unknown'}</td>
                    <td>${repo.stargazers_count || 0}</td>
                    <td>${repo.language || 'Unknown'}</td>
                    <td>${repo.event_count || 0}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        function toggleAllRepos(checkbox) {
            document.querySelectorAll('.repo-checkbox').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        // Data management functions
        function pruneData() {
            if (!requireAuth()) return;
            
            if (!confirm('This will remove old data and orphaned records. Are you sure?')) {
                return;
            }
            
            apiCall('/api/data/prune', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(`Data pruning completed. ${data.summary || 'Data cleaned up successfully'}`, 'success');
                        updateDatabaseStats(); // Refresh stats
                    } else {
                        showAlert(data.error || 'Data pruning failed', 'danger');
                    }
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function removeSelected() {
            if (!requireAuth()) return;
            
            const selectedRepos = document.querySelectorAll('.repo-checkbox:checked');
            if (selectedRepos.length === 0) {
                showAlert('No repositories selected', 'warning');
                return;
            }
            
            if (!confirm(`This will permanently delete ${selectedRepos.length} repositories and all their events. Are you sure?`)) {
                return;
            }
            
            const repoIds = Array.from(selectedRepos).map(cb => cb.value);
            
            apiCall('/api/data/remove-repositories', {
                method: 'POST',
                body: JSON.stringify({ repository_ids: repoIds })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(`Successfully removed ${data.removed_count || selectedRepos.length} repositories`, 'success');
                        searchRepositories(); // Refresh the repository list
                        updateDatabaseStats(); // Refresh stats
                    } else {
                        showAlert(data.error || 'Failed to remove repositories', 'danger');
                    }
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        function getDiskUsage() {
            if (!requireAuth()) return;
            
            apiCall('/api/system/disk-usage')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const usageDiv = document.getElementById('diskUsageDetails');
                        let html = '<h4>üìä Disk Usage Analysis</h4>';
                        
                        if (data.usage) {
                            html += `
                                <div class="metrics-grid">
                                    <div class="metric">
                                        <span>Total Space</span>
                                        <span class="metric-value">${data.usage.total_gb} GB</span>
                                    </div>
                                    <div class="metric">
                                        <span>Used Space</span>
                                        <span class="metric-value">${data.usage.used_gb} GB</span>
                                    </div>
                                    <div class="metric">
                                        <span>Free Space</span>
                                        <span class="metric-value">${data.usage.free_gb} GB</span>
                                    </div>
                                    <div class="metric">
                                        <span>Usage Percentage</span>
                                        <span class="metric-value">${data.usage.percent}%</span>
                                    </div>
                                </div>
                            `;
                            
                            if (data.usage.directories) {
                                html += '<h5>Directory Breakdown:</h5><ul>';
                                data.usage.directories.forEach(dir => {
                                    html += `<li><strong>${dir.path}</strong>: ${dir.size_gb} GB</li>`;
                                });
                                html += '</ul>';
                            }
                        }
                        
                        usageDiv.innerHTML = html;
                    } else {
                        showAlert(data.error || 'Failed to get disk usage', 'danger');
                    }
                })
                .catch(error => showAlert('Error: ' + error.message, 'danger'));
        }

        // Log viewing
        function refreshLogs() {
            fetch('/api/scraper-logs')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('logViewer').textContent = data.logs || 'No logs available';
                })
                .catch(error => {
                    document.getElementById('logViewer').textContent = 'Error loading logs: ' + error.message;
                });
        }

        function clearLogs() {
            document.getElementById('logViewer').textContent = 'Logs cleared from display';
        }

        // Periodic updates
        function startPeriodicUpdates() {
            updateInterval = setInterval(() => {
                updateSystemStatus();
                updateDatabaseStats();
                updateRateLimitStatus();
                updateScraperStatus();
            }, 5000); // Update every 5 seconds
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Always check auth status first
            checkAuthStatus();
            
            // Start basic updates (public endpoints)
            updateSystemStatus();
            updateRateLimitStatus();
            
            // Check if we have a stored token
            if (authToken) {
                fetch('/api/auth/status', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        checkAuthStatus();
                        startPeriodicUpdates();
                        // Initial load after authentication
                        updateDatabaseStats();
                        refreshLogs();
                    } else {
                        localStorage.removeItem('authToken');
                        authToken = null;
                        checkAuthStatus();
                    }
                })
                .catch(() => {
                    localStorage.removeItem('authToken');
                    authToken = null;
                    checkAuthStatus();
                });
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
